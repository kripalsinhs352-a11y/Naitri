<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NAITRI ENGINEERING - Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #2980b9; --danger: #c0392b; --white: #ffffff; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding-bottom: 80px; background: #f4f7f6; }
        .content { padding: 15px; }
        .card { background: var(--white); padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 15px; }
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: var(--white); display: flex; justify-content: space-around; border-top: 1px solid #ddd; z-index: 1000; height: 60px; }
        .nav-item { padding: 10px; text-align: center; cursor: pointer; flex: 1; color: #7f8c8d; font-size: 10px; }
        .nav-item.active-nav { color: var(--accent); font-weight: bold; border-top: 3px solid var(--accent); }
        input, select, textarea, button { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; margin-bottom: 10px; }
        button { background: var(--accent); color: white; border: none; font-weight: bold; cursor: pointer; }
        .btn-del { background: var(--danger); width: auto; padding: 5px 10px; font-size: 11px; border-radius: 4px; color: white; border: none; cursor: pointer; }
        .section { display: none; }
        .active { display: block; }
        table { width: 100%; border-collapse: collapse; background: white; margin-top: 10px; font-size: 11px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; vertical-align: top; }
        th { background: #f8f9fa; }
        .summary-card { background: #e8f4fd; border-left: 5px solid var(--accent); margin-top: 20px; }
    </style>
</head>
<body>

<div class="content">
    <div id="personEntry" class="section active">
        <div class="card">
            <h3>Employee Entry</h3>
            <label>Date:</label><input type="date" id="pDate">
            <label>Employee Name:</label><select id="pPerson"></select>
            <div style="display: flex; align-items: center; gap: 10px; background: #fff3f3; padding: 10px; border: 1px solid #ffcdd2; border-radius: 8px; margin-bottom: 10px;">
                <input type="checkbox" id="pIsLeave" style="width:20px; margin:0;" onchange="toggleLeave(this.checked)">
                <label for="pIsLeave"><b>Is Today a Leave?</b></label>
            </div>
            <label>Item Name:</label><select id="pItem"></select>
            <label>Quantity:</label><input type="number" id="pQty" value="1">
            <div style="display: flex; gap: 10px;">
                <div style="flex:1;"><label>In Time:</label><input type="time" id="pInTime"></div>
                <div style="flex:1;"><label>Out Time:</label><input type="time" id="pOutTime"></div>
            </div>
            <label>Lunch Break:</label><input type="time" id="pLunch" value="01:00">
            <label>Note:</label><textarea id="pNote" placeholder="Additional details..."></textarea>
            <button onclick="saveLog('PERSON')">Save Entry</button>
        </div>
    </div>

    <div id="externalEntry" class="section">
        <div class="card">
            <h3>Barni Item (External)</h3>
            <div style="display: flex; gap: 5px;">
                <input type="date" id="bFrom" placeholder="From"> 
                <input type="date" id="bTo" placeholder="To">
            </div>
            <button onclick="loadBarniLogs()">Filter/View All Barni</button>
            <button id="barniPdfBtn" style="display:none; background:green;" onclick="downloadBarniPDF()">Download Barni PDF</button>
            <hr>
            <label>New Entry:</label>
            <input type="date" id="bDate">
            <select id="bItem"></select>
            <select id="bName"></select>
            <input type="number" id="bQty" placeholder="Quantity">
            <textarea id="bNote" placeholder="Note/Details"></textarea>
            <button onclick="saveLog('BARNI')" style="background: #e67e22;">Save Barni Entry</button>
        </div>
        <div id="barniListContainer"></div>
    </div>

    <div id="report" class="section">
        <div class="card">
            <h3>Work Report</h3>
            <div style="display: flex; gap: 5px; align-items: center;">
                <input type="date" id="rfDate"> To <input type="date" id="rtDate">
            </div>
            <p style="font-size: 10px; color: gray;">*Leave blank to see all history</p>
            <button onclick="loadMainReport()">View Report</button>
            <button id="pdfBtn" style="display:none; background:green;" onclick="downloadMainPDF()">Download Report PDF</button>
        </div>
        <div id="reportOutput"></div>
    </div>

    <div id="activity" class="section">
        <div class="card">
            <h3>Recent Activity History</h3>
            <div id="activityLogs"></div>
        </div>
    </div>

    <div id="setting" class="section">
        <div class="card">
            <h3>Master Settings</h3>
            <input type="text" id="setVal" placeholder="Enter Name or Item">
            <select id="setCat">
                <option value="persons">Employee List</option>
                <option value="items">Item List</option>
                <option value="bItems">Barni Item List</option>
                <option value="bNames">Barni Vendor List</option>
            </select>
            <button onclick="addMaster()">Add New to List</button>
            <button onclick="syncToFB()" style="background:#8e44ad;">üîÑ Sync with Cloud</button>
        </div>
        <div id="masterLists"></div>
    </div>
</div>

<div class="bottom-nav">
    <div class="nav-item active-nav" onclick="showTab('personEntry', this)">üë§<br>Entry</div>
    <div class="nav-item" onclick="showTab('externalEntry', this)">üöö<br>Barni</div>
    <div class="nav-item" onclick="showTab('report', this)">üìä<br>Report</div>
    <div class="nav-item" onclick="showTab('activity', this)">üïí<br>Activity</div>
    <div class="nav-item" onclick="showTab('setting', this)">‚öôÔ∏è<br>Setting</div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
  import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC0RtJmMYwO45OjacHnpcv298DRBOOz1E0",
    authDomain: "naitri-a5975.firebaseapp.com",
    databaseURL: "https://naitri-a5975-default-rtdb.firebaseio.com/", 
    projectId: "naitri-a5975",
    storageBucket: "naitri-a5975.firebasestorage.app",
    messagingSenderId: "414479436661",
    appId: "1:414479436661:web:b1f66ea5b3844abfb2a13c"
  };

  const app = initializeApp(firebaseConfig);
  const fb_db = getDatabase(app);

  onValue(ref(fb_db, 'sync_data/'), (snapshot) => {
    const data = snapshot.val();
    if (data) {
        if(data.logs) db.logs = data.logs;
        if(data.masters) {
            db.items = data.masters.items || [];
            db.persons = data.masters.persons || [];
            db.bItems = data.masters.bItems || [];
            db.bNames = data.masters.bNames || [];
        }
        if(data.activity) db.activity = data.activity;
        saveToLocalStorage();
        updateDropdowns();
        if(document.getElementById('setting').classList.contains('active')) renderMaster();
    }
  });

  window.syncToFB = () => {
    set(ref(fb_db, 'sync_data/'), {
        logs: db.logs,
        masters: { items: db.items, persons: db.persons, bItems: db.bItems, bNames: db.bNames },
        activity: db.activity || []
    });
    console.log("Data Synced with Cloud!");
  };
</script>

<script>
let db = JSON.parse(localStorage.getItem('bizV4')) || { items:[], persons:[], bItems:[], bNames:[], logs:[], activity:[] };

function saveToLocalStorage() { localStorage.setItem('bizV4', JSON.stringify(db)); }

function addActivity(msg) {
    if(!db.activity) db.activity = [];
    db.activity.push(`${new Date().toLocaleString()} - ${msg}`);
    if(db.activity.length > 30) db.activity.shift();
}

function formatDate(d) { if(!d) return "-"; let [y, m, day] = d.split('-'); return `${day}/${m}/${y}`; }
function timeToDec(t) { if(!t) return 0; let [h, m] = t.split(':').map(Number); return h + (m/60); }
function formatHrs(dec) {
    if(dec <= 0) return "0h 00m";
    let h = Math.floor(dec);
    let m = Math.round((dec - h) * 60);
    return `${h}h ${m.toString().padStart(2, '0')}m`;
}
function t12(t) {
    if(!t) return '-';
    let [h, m] = t.split(':');
    let am = h >= 12 ? 'PM' : 'AM';
    h = h % 12 || 12;
    return `${h}:${m} ${am}`;
}

function toggleLeave(isl) {
    ['pItem', 'pQty', 'pInTime', 'pOutTime', 'pLunch'].forEach(id => document.getElementById(id).disabled = isl);
}

function showTab(id, el) {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active-nav'));
    document.getElementById(id).classList.add('active');
    el.classList.add('active-nav');
    updateDropdowns();
    if(id === 'activity') renderActivity();
    if(id === 'setting') renderMaster();
}

function updateDropdowns() {
    const fill = (id, arr) => {
        let el = document.getElementById(id);
        if(el) el.innerHTML = (arr || []).map(a => `<option>${a}</option>`).join('');
    };
    fill('pPerson', db.persons); fill('pItem', db.items);
    fill('bItem', db.bItems); fill('bName', db.bNames);
}

function saveLog(type) {
    let dateVal = document.getElementById(type==='PERSON' ? 'pDate' : 'bDate').value;
    if(!dateVal) { alert("Please select a date"); return; }
    
    let entry = {
        type, 
        date: dateVal,
        name: document.getElementById(type==='PERSON' ? 'pPerson' : 'bName').value,
        item: type==='PERSON' && document.getElementById('pIsLeave').checked ? "LEAVE" : document.getElementById(type==='PERSON' ? 'pItem' : 'bItem').value,
        qty: document.getElementById(type==='PERSON' ? 'pQty' : 'bQty').value,
        inT: type==='PERSON' ? document.getElementById('pInTime').value : "",
        outT: type==='PERSON' ? document.getElementById('pOutTime').value : "",
        lunch: type==='PERSON' ? document.getElementById('pLunch').value : "01:00",
        note: document.getElementById(type==='PERSON' ? 'pNote' : 'bNote').value
    };
    db.logs.push(entry);
    addActivity(`New Entry: ${entry.name} (${type})`);
    saveToLocalStorage();
    if(window.syncToFB) window.syncToFB();
    alert('Entry Saved!');
}

// --- DELETE LOG FUNCTION ---
window.deleteLog = (index, refreshType) => {
    if(confirm("‡™∂‡´Å‡™Ç ‡™§‡™Æ‡´á ‡™Ü ‡™è‡™®‡´ç‡™ü‡´ç‡™∞‡´Ä ‡™°‡´Ä‡™≤‡´Ä‡™ü ‡™ï‡™∞‡™µ‡™æ ‡™Æ‡™æ‡™Ç‡™ó‡´ã ‡™õ‡´ã?")) {
        let deletedItem = db.logs[index];
        addActivity(`Deleted: ${deletedItem.name} - ${deletedItem.item}`);
        db.logs.splice(index, 1);
        saveToLocalStorage();
        if(window.syncToFB) window.syncToFB();
        
        if(refreshType === 'MAIN') loadMainReport();
        else loadBarniLogs();
        alert("‡™è‡™®‡´ç‡™ü‡´ç‡™∞‡´Ä ‡™°‡´Ä‡™≤‡´Ä‡™ü ‡™•‡™à ‡™ó‡™à ‡™õ‡´á.");
    }
}

function loadMainReport() {
    let f = document.getElementById('rfDate').value;
    let t = document.getElementById('rtDate').value;
    let html = '';
    let personLogs = db.logs.filter(l => l.type === 'PERSON');
    let names = [...new Set(personLogs.map(d => d.name))];

    if(names.length === 0) { html = '<p>No data found.</p>'; }

    names.forEach(n => {
        html += `<h4>Operator: ${n}</h4><table>
            <tr><th>Date</th><th>Item</th><th>Qty</th><th>In/Out</th><th>Total Time</th><th>Action</th></tr>`;
        
        db.logs.forEach((p, index) => {
            if(p.type === 'PERSON' && p.name === n) {
                if((f && p.date < f) || (t && p.date > t)) return;
                let net = (p.inT && p.outT) ? (timeToDec(p.outT) - timeToDec(p.inT) - timeToDec(p.lunch || '01:00')) : 0;
                html += `<tr>
                    <td>${formatDate(p.date)}</td>
                    <td>${p.item}</td>
                    <td>${p.qty}</td>
                    <td>${t12(p.inT)} - ${t12(p.outT)}</td>
                    <td><b>${formatHrs(net)}</b></td>
                    <td><button class="btn-del" onclick="deleteLog(${index}, 'MAIN')">Delete</button></td>
                </tr>`;
            }
        });
        html += `</table>`;
    });

    // Summary Section
    html += `<div class="card summary-card"><h3>üìä Category Summary</h3>`;
    names.forEach(n => {
        let summary = {};
        db.logs.filter(l => {
            if(l.type !== 'PERSON' || l.name !== n) return false;
            if((f && l.date < f) || (t && l.date > t)) return false;
            return true;
        }).forEach(l => { summary[l.item] = (summary[l.item] || 0) + Number(l.qty); });
        
        html += `<b>${n}</b><table>`;
        for(let item in summary) html += `<tr><td>${item}</td><td><b>${summary[item]}</b></td></tr>`;
        html += `</table><br>`;
    });
    html += `</div>`;

    document.getElementById('reportOutput').innerHTML = html;
    document.getElementById('pdfBtn').style.display = 'block';
}

function downloadMainPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    let f = document.getElementById('rfDate').value;
    let t = document.getElementById('rtDate').value;
    let personLogs = db.logs.filter(l => l.type === 'PERSON');
    let names = [...new Set(personLogs.map(d => d.name))];
    let y = 20;

    doc.text("NAITRI ENGINEERING - Work Report", 14, 15);
    names.forEach(n => {
        doc.text(`Operator: ${n}`, 14, y);
        let rows = [];
        db.logs.forEach(p => {
            if(p.type === 'PERSON' && p.name === n) {
                if((f && p.date < f) || (t && p.date > t)) return;
                let net = (p.inT && p.outT) ? (timeToDec(p.outT) - timeToDec(p.inT) - timeToDec(p.lunch || '01:00')) : 0;
                rows.push([formatDate(p.date), p.item, p.qty, t12(p.inT), t12(p.outT), p.lunch || '01:00', formatHrs(net)]);
            }
        });

        doc.autoTable({ head: [['Date', 'Item', 'Qty', 'In', 'Out', 'Lunch', 'Time']], body: rows, startY: y + 2 });
        y = doc.lastAutoTable.finalY + 10;
        
        if(y > 250) { doc.addPage(); y = 20; }
    });
    doc.save("Naitri_Work_Report.pdf");
}

function loadBarniLogs() {
    let f = document.getElementById('bFrom').value, t = document.getElementById('bTo').value;
    let html = '<h3>Barni Logs</h3>';
    let vendors = [...new Set(db.logs.filter(l => l.type === 'BARNI').map(l => l.name))];
    
    vendors.forEach(n => {
        html += `<div class="card"><b>Vendor: ${n}</b><table><tr><th>Date</th><th>Item</th><th>Qty</th><th>Action</th></tr>`;
        db.logs.forEach((l, index) => {
            if(l.type === 'BARNI' && l.name === n) {
                if((f && l.date < f) || (t && l.date > t)) return;
                html += `<tr><td>${formatDate(l.date)}</td><td>${l.item}</td><td>${l.qty}</td>
                <td><button class="btn-del" onclick="deleteLog(${index}, 'BARNI')">Delete</button></td></tr>`;
            }
        });
        html += `</table></div>`;
    });
    document.getElementById('barniListContainer').innerHTML = html;
    document.getElementById('barniPdfBtn').style.display = 'block';
}

function downloadBarniPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    let f = document.getElementById('bFrom').value, t = document.getElementById('bTo').value;
    let logs = db.logs.filter(l => {
        if (l.type !== 'BARNI') return false;
        if ((f && l.date < f) || (t && l.date > t)) return false;
        return true;
    });

    doc.text("NAITRI ENGINEERING - Barni Report", 14, 15);
    let rows = logs.map(l => [formatDate(l.date), l.name, l.item, l.qty]);
    doc.autoTable({ head: [['Date', 'Vendor', 'Item', 'Qty']], body: rows, startY: 25 });
    doc.save("Barni_Report.pdf");
}

function renderActivity() {
    document.getElementById('activityLogs').innerHTML = (db.activity || []).slice().reverse().map(a => `<div class="card" style="font-size:12px;">${a}</div>`).join('');
}

function addMaster() {
    let c = document.getElementById('setCat').value, v = document.getElementById('setVal').value;
    if(v) { 
        if(!db[c]) db[c] = [];
        db[c].push(v); 
        saveToLocalStorage(); 
        if(window.syncToFB) window.syncToFB(); 
        document.getElementById('setVal').value = '';
        renderMaster(); 
    }
}

function renderMaster() {
    let html = '';
    let sections = { persons: 'Employees', items: 'Items', bItems: 'Barni Items', bNames: 'Barni Vendors' };
    Object.keys(sections).forEach(c => {
        html += `<div class="card"><b>${sections[c]}</b><hr>`;
        (db[c] || []).forEach((v, i) => {
            html += `<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                <span>${v}</span> 
                <button class="btn-del" onclick="deleteMaster('${c}', ${i})">Delete</button>
            </div>`;
        });
        html += `</div>`;
    });
    document.getElementById('masterLists').innerHTML = html;
}

window.deleteMaster = (cat, index) => {
    if(confirm("Are you sure?")) {
        db[cat].splice(index, 1);
        saveToLocalStorage();
        if(window.syncToFB) window.syncToFB();
        renderMaster();
        updateDropdowns();
    }
}

window.addEventListener('load', () => {
    let today = new Date().toISOString().split('T')[0];
    if(document.getElementById('pDate')) document.getElementById('pDate').value = today;
    if(document.getElementById('bDate')) document.getElementById('bDate').value = today;
    let yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);
    if(document.getElementById('bFrom')) document.getElementById('bFrom').value = yesterday.toISOString().split('T')[0];
    if(document.getElementById('bTo')) document.getElementById('bTo').value = today;
});

updateDropdowns();
</script>
</body>
</html>
